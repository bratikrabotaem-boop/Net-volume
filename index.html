<script>
/* ===== iOS ZOOM BLOCK ===== */
['gesturestart','gesturechange','gestureend'].forEach(e=>{
  document.addEventListener(e,ev=>ev.preventDefault(),{passive:false});
});

let INTERVAL = '1h';
let ws = null;
let wsTF = null;

/* ===== COMMON OPTIONS ===== */
const commonOpts = {
  layout:{ background:{color:'#121417'}, textColor:'#ccc' },
  grid:{ vertLines:{color:'#1e2228'}, horzLines:{color:'#1e2228'} },
  timeScale:{
    timeVisible:true,
    rightBarStaysOnScroll:true,
    lockVisibleTimeRangeOnResize:true
  },
  handleScroll:{
    mouseWheel:false,
    pressedMouseMove:true,
    horzTouchDrag:true,
    vertTouchDrag:false
  }
};

/* ===== PRICE CHART ===== */
const priceChart = LightweightCharts.createChart(
  document.getElementById('price'),
  {
    ...commonOpts,
    handleScale:{ mouseWheel:false, axisPressedMouseMove:false, pinch:true },
    rightPriceScale:{visible:false},
    leftPriceScale:{visible:false}
  }
);

const candles = priceChart.addCandlestickSeries({
  upColor:'#1fc77b',
  downColor:'#e04b4b',
  borderUpColor:'#1fc77b',
  borderDownColor:'#e04b4b',
  wickUpColor:'#1fc77b',
  wickDownColor:'#e04b4b'
});

/* ===== VOLUME CHART ===== */
const volumeChart = LightweightCharts.createChart(
  document.getElementById('volume'),
  {
    ...commonOpts,
    handleScale:{ mouseWheel:false, axisPressedMouseMove:false, pinch:false },
    rightPriceScale:{visible:false},
    leftPriceScale:{visible:false}
  }
);

const volume = volumeChart.addHistogramSeries({
  base:0,
  priceFormat:{type:'volume'}
});

/* ===== SYNC ===== */
let syncing = false;
function syncCharts(a,b){
  a.timeScale().subscribeVisibleLogicalRangeChange(range=>{
    if(syncing || !range) return;
    syncing = true;
    b.timeScale().setVisibleLogicalRange(range);
    syncing = false;
  });
}
syncCharts(priceChart, volumeChart);
syncCharts(volumeChart, priceChart);

/* ===== RESIZE ===== */
function resizeCharts(){
  priceChart.resize(
    document.getElementById('price').clientWidth,
    document.getElementById('price').clientHeight
  );
  volumeChart.resize(
    document.getElementById('volume').clientWidth,
    document.getElementById('volume').clientHeight
  );
}
window.addEventListener('resize', resizeCharts);

/* ===== LOAD HISTORY ===== */
async function loadData(){
  if (ws) {
    ws.onmessage = null;
    ws.close();
    ws = null;
  }

  candles.setData([]);
  volume.setData([]);

  const r = await fetch(
    `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${INTERVAL}&limit=500`
  );
  const d = await r.json();

  const c=[], v=[];
  d.forEach(k=>{
    const time = Math.floor(k[0]/1000);

    c.push({
      time,
      open:+k[1],
      high:+k[2],
      low:+k[3],
      close:+k[4]
    });

    const net = 2*k[10] - k[7];
    v.push({
      time,
      value:net/1e6,
      color:net>=0?'#1fc77b':'#e04b4b'
    });
  });

  candles.setData(c);
  volume.setData(v);

  priceChart.timeScale().fitContent();
  resizeCharts();

  startRealtime();
}

/* ===== REALTIME ===== */
function startRealtime(){
  wsTF = INTERVAL;

  ws = new WebSocket(
    `wss://stream.binance.com:9443/ws/btcusdt@kline_${INTERVAL}`
  );

  ws.onmessage = e => {
    if (wsTF !== INTERVAL) return;

    const k = JSON.parse(e.data).k;
    if (!k.x) return; // только закрытые свечи

    const time = Math.floor(k.t/1000);

    candles.update({
      time,
      open:+k.o,
      high:+k.h,
      low:+k.l,
      close:+k.c
    });

    const net = 2*k.Q - k.V;
    volume.update({
      time,
      value:net/1e6,
      color:net>=0?'#1fc77b':'#e04b4b'
    });
  };

  ws.onclose = () => {
    if (wsTF === INTERVAL) {
      setTimeout(startRealtime, 2000);
    }
  };
}

/* ===== TIMEFRAME ===== */
function setTF(tf){
  INTERVAL = tf;

  document.querySelectorAll('.tf-buttons button')
    .forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');

  loadData();
}

loadData();
</script>
