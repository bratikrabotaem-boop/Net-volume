<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>BTC-USDT · Net Volume (Realtime)</title>

<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<style>
body {
  margin:0;
  background:#121417;
  color:#e6e6e6;
  font-family:Arial,sans-serif;
}
.wrapper {
  max-width:1100px;
  margin:20px auto;
  padding:0 10px;
}
.title { text-align:center; font-size:18px; }
.sub { text-align:center; font-size:13px; color:#8a8a8a; margin-bottom:8px; }

.tf-buttons {
  display:flex;
  justify-content:center;
  gap:8px;
  margin-bottom:8px;
}
.tf-buttons button {
  background:#2a2d33;
  border:0;
  color:#ccc;
  padding:5px 10px;
  border-radius:4px;
  font-size:12px;
  cursor:pointer;
}
.tf-buttons button.active {
  background:#3f434b;
  color:#fff;
}

#price,#volume {
  width:100%;
  touch-action:none;
}
#price { height:420px; }
#volume { height:140px; }
</style>
</head>

<body>
<div class="wrapper">
  <div class="title">BTC-USDT · NET VOLUME</div>
  <div class="sub">BINANCE · REALTIME</div>

  <div class="tf-buttons">
    <button data-tf="1d">1D</button>
    <button data-tf="4h">4H</button>
    <button data-tf="1h" class="active">1H</button>
    <button data-tf="30m">30M</button>
    <button data-tf="15m">15M</button>
    <button data-tf="5m">5M</button>
  </div>

  <div id="price"></div>
  <div id="volume"></div>
</div>

<script>
/* ================== CONST ================== */
const SYMBOL = 'BTCUSDT';
const LIMIT = 500;
const VOLUME_DIVIDER = 1e6;
const RECONNECT_BASE = 2000;
const RECONNECT_MAX = 30000;

/* ================== iOS ZOOM BLOCK ================== */
['gesturestart','gesturechange','gestureend'].forEach(e=>{
  document.addEventListener(e,ev=>ev.preventDefault(),{passive:false});
});

/* ================== TIME FORMAT ================== */
function formatTimeNoSeconds(time){
  const d = new Date(time * 1000);
  return d.toLocaleDateString('ru-RU',{day:'2-digit',month:'short',year:'2-digit'}) +
         ` ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

/* ================== STATE ================== */
let INTERVAL = '1h';
let ws = null;
let sessionId = 0;
let reconnectDelay = RECONNECT_BASE;

let currentBarTime = null;
let lastV = 0;
let lastQ = 0;
let currentNet = 0;
let baseNet = 0;
let rafLock = false;

/* ================== UTILS ================== */
const calcNet = (dQ,dV)=>2*dQ - dV;

/* ================== COMMON OPTIONS ================== */
const commonOpts = {
  layout:{ background:{color:'#121417'}, textColor:'#ccc' },
  grid:{ vertLines:{color:'#1e2228'}, horzLines:{color:'#1e2228'} },
  localization:{ timeFormatter:formatTimeNoSeconds },
  crosshair:{ mode:LightweightCharts.CrosshairMode.Normal },
  timeScale:{
    timeVisible:true,
    secondsVisible:false,
    rightBarStaysOnScroll:true,
    lockVisibleTimeRangeOnResize:true
  },
  handleScroll:{ mouseWheel:false, pressedMouseMove:true, horzTouchDrag:true }
};

/* ================== CHARTS ================== */
const priceChart = LightweightCharts.createChart(
  price,
  {...commonOpts, handleScale:{mouseWheel:false,pinch:true}}
);
const candles = priceChart.addCandlestickSeries({
  upColor:'#1fc77b', downColor:'#e04b4b',
  borderUpColor:'#1fc77b', borderDownColor:'#e04b4b',
  wickUpColor:'#1fc77b', wickDownColor:'#e04b4b'
});

const volumeChart = LightweightCharts.createChart(
  volume,
  {...commonOpts, handleScale:{mouseWheel:false,pinch:false}}
);
const volumeSeries = volumeChart.addHistogramSeries({
  base:0, priceFormat:{type:'volume'}
});

/* ================== SYNC ================== */
let syncing=false;
function sync(a,b){
  a.timeScale().subscribeVisibleLogicalRangeChange(r=>{
    if(syncing||!r) return;
    syncing=true;
    b.timeScale().setVisibleLogicalRange(r);
    syncing=false;
  });
}
sync(priceChart,volumeChart);
sync(volumeChart,priceChart);

/* ================== RESIZE ================== */
function resize(){
  priceChart.resize(price.clientWidth,price.clientHeight);
  volumeChart.resize(volume.clientWidth,volume.clientHeight);
}
window.addEventListener('resize',resize);

/* ================== LOAD HISTORY ================== */
async function loadData(){
  sessionId++;
  const sid=sessionId;

  currentBarTime=null;
  currentNet=0;
  baseNet=0;
  reconnectDelay=RECONNECT_BASE;

  if(ws){ ws.close(); ws=null; }

  try{
    const r=await fetch(
      `https://api.binance.com/api/v3/klines?symbol=${SYMBOL}&interval=${INTERVAL}&limit=${LIMIT}`
    );
    if(!r.ok) throw new Error('HTTP '+r.status);
    const d=await r.json();

    const c=[],v=[];
    d.forEach(k=>{
      const t=k[0]/1000;
      const net=calcNet(+k[10],+k[7]);
      c.push({time:t,open:+k[1],high:+k[2],low:+k[3],close:+k[4]});
      v.push({time:t,value:net/VOLUME_DIVIDER,color:net>=0?'#1fc77b':'#e04b4b'});
    });

    baseNet=calcNet(+d.at(-1)[10],+d.at(-1)[7]);

    candles.setData(c);
    volumeSeries.setData(v);
    priceChart.timeScale().fitContent();
    resize();

    startRealtime(sid);
  }catch(e){
    console.error('Load error',e);
  }
}

/* ================== REALTIME ================== */
function startRealtime(sid){
  ws=new WebSocket(`wss://stream.binance.com:9443/ws/btcusdt@kline_${INTERVAL}`);

  ws.onmessage=e=>{
    if(sid!==sessionId||rafLock) return;
    rafLock=true;
    requestAnimationFrame(()=>{
      rafLock=false;
      const k=JSON.parse(e.data).k;
      const time=Math.floor(k.t/1000);

      candles.update({time,open:+k.o,high:+k.h,low:+k.l,close:+k.c});

      if(currentBarTime!==time){
        currentBarTime=time;
        lastV=+k.V; lastQ=+k.Q;
        currentNet=baseNet;
      }

      const dV=+k.V-lastV;
      const dQ=+k.Q-lastQ;
      lastV=+k.V; lastQ=+k.Q;

      currentNet+=calcNet(dQ,dV);

      volumeSeries.update({
        time,
        value:currentNet/VOLUME_DIVIDER,
        color:currentNet>=0?'#1fc77b':'#e04b4b'
      });
    });
  };

  ws.onclose=()=>{
    if(sid!==sessionId) return;
    setTimeout(()=>startRealtime(sid),reconnectDelay);
    reconnectDelay=Math.min(reconnectDelay*1.5,RECONNECT_MAX);
  };
}

/* ================== TF ================== */
document.querySelector('.tf-buttons').onclick=e=>{
  if(!e.target.dataset.tf) return;
  INTERVAL=e.target.dataset.tf;
  document.querySelectorAll('.tf-buttons button')
    .forEach(b=>b.classList.toggle('active',b===e.target));
  loadData();
};

/* ================== CLEANUP ================== */
window.addEventListener('beforeunload',()=>{
  if(ws) ws.close();
});

loadData();
</script>
</body>
</html>
