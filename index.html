<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>BTC-USDT 路 Net Volume (Realtime)</title>

<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<style>
body {
  margin:0;
  background:#121417;
  color:#e6e6e6;
  font-family:Arial,sans-serif;
}
.wrapper {
  max-width:1100px;
  margin:20px auto;
  padding:0 10px;
}
.title { text-align:center; font-size:18px; }
.sub { text-align:center; font-size:13px; color:#8a8a8a; margin-bottom:8px; }

.tf-buttons {
  display:flex;
  justify-content:center;
  gap:8px;
  margin-bottom:8px;
}
.tf-buttons button {
  background:#2a2d33;
  border:0;
  color:#ccc;
  padding:5px 10px;
  border-radius:4px;
  font-size:12px;
}
.tf-buttons button.active {
  background:#3f434b;
  color:#fff;
}

#price,#volume {
  touch-action:none !important;
  width:100%;
}
#price { height:420px; }
#volume { height:140px; }
</style>
</head>

<body>
<div class="wrapper">
  <div class="title">BTC-USDT 路 NET VOLUME</div>
  <div class="sub">BINANCE 路 REALTIME</div>

  <div class="tf-buttons">
    <button onclick="setTF('1d')">1D</button>
    <button onclick="setTF('4h')">4H</button>
    <button onclick="setTF('1h')" class="active">1H</button>
    <button onclick="setTF('30m')">30M</button>
    <button onclick="setTF('15m')">15M</button>
    <button onclick="setTF('5m')">5M</button>
  </div>

  <div id="price"></div>
  <div id="volume"></div>
</div>

<script>
/* ===== GLOBAL ===== */
let INTERVAL = '1h';
let ws = null;
let sessionId = 0;
const tz = -new Date().getTimezoneOffset() * 60;

/* ===== TF SECONDS ===== */
function tfSec(){
  return {
    '1d':86400,
    '4h':14400,
    '1h':3600,
    '30m':1800,
    '15m':900,
    '5m':300
  }[INTERVAL];
}

/* ===== COMMON OPTIONS ===== */
const commonOpts = {
  layout:{ background:{color:'#121417'}, textColor:'#ccc' },
  grid:{ vertLines:{color:'#1e2228'}, horzLines:{color:'#1e2228'} },
  timeScale:{
    timeVisible:true,
    secondsVisible:false,
    rightBarStaysOnScroll:true,
    lockVisibleTimeRangeOnResize:true,
    tickMarkFormatter:(time)=>{
      const d = new Date(time * 1000);
      const h = String(d.getHours()).padStart(2,'0');
      const m = String(d.getMinutes()).padStart(2,'0');
      return `${h}:${m}`;
    }
  },
  handleScroll:{
    mouseWheel:false,
    pressedMouseMove:true,
    horzTouchDrag:true,
    vertTouchDrag:false
  }
};

/* ===== CHARTS ===== */
const priceChart = LightweightCharts.createChart(
  document.getElementById('price'),
  {
    ...commonOpts,
    handleScale:{ mouseWheel:false, axisPressedMouseMove:false, pinch:true },
    rightPriceScale:{visible:false},
    leftPriceScale:{visible:false}
  }
);

const candles = priceChart.addCandlestickSeries({
  upColor:'#1fc77b',
  downColor:'#e04b4b',
  borderUpColor:'#1fc77b',
  borderDownColor:'#e04b4b',
  wickUpColor:'#1fc77b',
  wickDownColor:'#e04b4b'
});

const volumeChart = LightweightCharts.createChart(
  document.getElementById('volume'),
  {
    ...commonOpts,
    handleScale:{ mouseWheel:false, axisPressedMouseMove:false, pinch:false },
    rightPriceScale:{visible:false},
    leftPriceScale:{visible:false}
  }
);

const volume = volumeChart.addHistogramSeries({
  base:0,
  priceFormat:{type:'volume'}
});

/* ===== SYNC ===== */
let syncing=false;
function sync(a,b){
  a.timeScale().subscribeVisibleLogicalRangeChange(r=>{
    if(syncing||!r)return;
    syncing=true;b.timeScale().setVisibleLogicalRange(r);syncing=false;
  });
}
sync(priceChart,volumeChart);
sync(volumeChart,priceChart);

/* ===== RESIZE ===== */
function resize(){
  priceChart.resize(price.clientWidth,price.clientHeight);
  volumeChart.resize(volume.clientWidth,volume.clientHeight);
}
window.addEventListener('resize',resize);

/* ===== LOAD HISTORY ===== */
async function loadData(){
  sessionId++;
  const id = sessionId;

  if(ws){
    ws.onmessage=null;
    ws.close();
    ws=null;
  }

  const r = await fetch(
    `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${INTERVAL}&limit=500`
  );
  const d = await r.json();

  const c=[], v=[];
  d.forEach(k=>{
    const t = k[0]/1000 + tz;

    c.push({
      time:t,
      open:+k[1],
      high:+k[2],
      low:+k[3],
      close:+k[4]
    });

    const net = 2*k[10] - k[7];
    v.push({
      time:t,
      value:net/1e6,
      color:net>=0?'#1fc77b':'#e04b4b'
    });
  });

  candles.setData(c);
  volume.setData(v);

  priceChart.timeScale().fitContent();
  resize();

  startRealtime(id);
}

/* ===== REALTIME ===== */
function startRealtime(id){
  ws = new WebSocket(
    `wss://stream.binance.com:9443/ws/btcusdt@kline_${INTERVAL}`
  );

  ws.onmessage = e=>{
    if(id!==sessionId) return;

    const k = JSON.parse(e.data).k;

    /*  挟效 肖小 */
    const raw = k.t/1000 + tz;
    const time = raw - (raw % tfSec());

    candles.update({
      time,
      open:+k.o,
      high:+k.h,
      low:+k.l,
      close:+k.c
    });

    const net = 2*k.Q - k.V;
    volume.update({
      time,
      value:net/1e6,
      color:net>=0?'#1fc77b':'#e04b4b'
    });
  };

  ws.onclose=()=>{
    if(id===sessionId)
      setTimeout(()=>startRealtime(id),2000);
  };
}

/* ===== TIMEFRAME ===== */
function setTF(tf){
  INTERVAL=tf;
  document.querySelectorAll('.tf-buttons button')
    .forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  loadData();
}

loadData();
</script>
</body>
</html>
